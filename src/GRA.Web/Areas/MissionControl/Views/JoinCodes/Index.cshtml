@model GRA.Controllers.ViewModel.MissionControl.JoinCodes.JoinCodeListViewModel

@section inHeading {
	<div class="ms-auto d-print-none">
		<a class="btn btn-outline-success"
		   data-bs-toggle="modal"
		   data-bs-target="#getModal">
			<span class="fas fa-link fa-fw"></span>
			Get Join Code
		</a>
	</div>
}

<div class="row mt-3">
	<div class="col-12">
		@if (Model.JoinCodes.Count() == 0)
		{
			<div class="alert alert-warning">No join codes created</div>
		}
		else
		{
			<div>
				<table class="table table-sm table-bordered link-table">
					<thead>
						<tr>
							<th>Branch</th>
							<th>Type</th>
							<th>Access Count</th>
							<th>Join Count</th>
							@if (Model.CanManageJoinCodes)
							{
								<th style="width: 4rem;">&nbsp;</th>
							}
						</tr>
					</thead>
					<tbody>
						@foreach (var joinCode in Model.JoinCodes)
						{
							<tr>
								<td class="td-class branchText">
									<a class="rowlink"
									   data-branchname="@joinCode.BranchName"
									   data-joincode="@joinCode.Code"
									   data-isqr="@joinCode.IsQRCode">
										@if (joinCode.BranchId.HasValue)
										{
											@:@joinCode.BranchName (@joinCode.BranchSystemName)
										}
										else
										{
											@:No branch
										}
									</a>
								</td>
								<td class="td-class typeText">
									@(joinCode.IsQRCode ? "QR Code" : "Url Link")
								</td>
								<td class="td-class">
									@joinCode.AccessCount
								</td>
								<td class="td-class">
									@joinCode.JoinCount
								</td>
								@if (Model.CanManageJoinCodes)
								{
									<td class="on-top d-flex justify-content-evenly">
										<button type="button"
												class="btn btn-outline-danger btn-sm"
												data-bs-toggle="modal"
												data-bs-target="#deleteModal"
												data-id="@joinCode.Id">
											<span class="fas fa-times fa-fw" aria-hidden="true"></span>
										</button>
									</td>
								}
							</tr>
						}
					</tbody>
				</table>
			</div>
			<paginate paginateModel="@Model"></paginate>
		}
	</div>
</div>

<div class="modal fade"
	 id="getModal"
	 tabindex="-1"
	 role="dialog"
	 aria-labelledby="getModalLabel">
	<div class="modal-dialog" role="document">
		<form asp-controller="@JoinCodesController.Name"
			  asp-action="@nameof(JoinCodesController.GetCode)"
			  id="getCodeForm"
			  method="post"
			  role="form"
			  style="display:inline">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title h4" id="addModalLabel">Get Join Code</h1>
					<button type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close dialog">
					</button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label asp-for="IsQRCode" class="col-form-label"></label>
						<select asp-for="IsQRCode" class="form-select" value="true">
							<option value="true" selected="true">QR Code</option>
							<option value="false">Url Link</option>
						</select>
						<span asp-validation-for="IsQRCode" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="BranchId" class="col-form-label"></label>
						<select asp-for="BranchId"
								asp-items="Model.BranchList"
								class="form-select">
							<option></option>
						</select>
						<span asp-validation-for="BranchId" class="text-danger"></span>
					</div>

				</div>
				<div class="modal-footer">
					<button type="button"
							class="btn btn-outline-secondary"
							data-bs-dismiss="modal">
						Cancel
					</button>
					<button type="submit"
							class="btn btn-outline-primary"
							aria-label="Confirm"
							button-spinner>
						Get Code
					</button>
				</div>
			</div>
		</form>
	</div>
</div>

<div class="modal fade"
	 id="viewModal"
	 tabindex="-1"
	 role="dialog"
	 aria-labelledby="getModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title h4" id="viewModalLabel">View Join Code</h1>
				<button type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close dialog">
				</button>
			</div>
			<div class="modal-body">
				<div id="qrCodeContainer" class="text-center">
					<div id="qrImage" class="mb-2"></div>
					<div class="btn-group">
						<button id="qrDownloadButton"
								class="btn btn-outline-primary"
								type="button">
							Download
						</button>
						<select id="qrDownloadOption"
								class="btn btn-outline-primary">
							<option value="png">PNG</option>
							<option value="svg">SVG</option>
						</select>
					</div>
				</div>
				<div id="urlLinkContainer" class="mb-3">
					<div class="input-group">
						<button id="copyUrlButton"
								class="btn btn-outline-primary"
								type="button">
							<span class="fas fa-clipboard fa-fw"></span>
						</button>
						<input id="urlInput" class="form-control" readonly="readonly" />
					</div>
					<span id="copyResultMessage" class="text-success position-absolute">Link copied</span>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button"
						class="btn btn-outline-secondary"
						data-bs-dismiss="modal">
					Close
				</button>
			</div>
		</div>
	</div>
</div>

@if (Model.CanManageJoinCodes)
{
	<div class="row">
		<div class="modal fade"
			 id="deleteModal"
			 tabindex="-1"
			 role="dialog"
			 aria-labelledby="deleteModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title h4" id="deleteModalLabel">Delete join code</h1>
						<button type="button"
								class="btn-close"
								data-bs-dismiss="modal"
								aria-label="Close dialog">
						</button>
					</div>
					<div class="modal-body p-0">
						<div class="modal-body d-flex align-items-stretch">
							<span class="fas fa-exclamation-triangle fa-lg text-danger pt-2 me-3"
								  aria-hidden="true"></span>
							<span id="modal-text"></span>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button"
								class="btn btn-outline-secondary"
								data-bs-dismiss="modal">
							Cancel
						</button>
						<form asp-controller="@JoinCodesController.Name"
							  asp-action="@nameof(JoinCodesController.Delete)"
							  method="post"
							  role="form"
							  style="display:inline">
							<input asp-for="CurrentPage" type="hidden" />
							<input asp-for="DeleteId" type="hidden" />
							<button id="modal-deleteButton"
									type="submit"
									class="btn btn-outline-danger"
									aria-label="Confirm">
								<span class="fas fa-times fa-fw" aria-hidden="true"></span>
								Delete
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
}

@section scripts {
	<script src="/js/qr-code-styling.min.js"></script>

	<script>
		$(window).on('load', function () {
			$('.td-class').each(function () {
				$(this).children('a.rowlink').height($(this).outerHeight());
			});
		});
		$(window).resize(function () {
			$('.td-class').each(function () {
				$(this).children('a.rowlink').height($(this).outerHeight());
			});
		});

		const copyResultMessage = $('#copyResultMessage');
		copyResultMessage.hide();

		const qrCode = new QRCodeStyling({
				width: 300,
				height: 300,
				type: "svg"
			});

		$('.rowlink').on('click', function () {
			const branchName = $(this).data('branchname');
			const branchText = $(this).text().trim();
			const joinUrl = "@Model.JoinUrl"
				.replace('@JoinCodesController.CodeReplacementKey', $(this).data('joincode'));
			const isQRCode = $(this).data('isqr');

			ShowViewModal(joinUrl, isQRCode, branchName, branchText);
		});

		$('#copyUrlButton').on('click', function() {
			const urlText = $('#urlInput').val();
			navigator.clipboard.writeText(urlText);
			copyResultMessage.show().delay(1000).fadeOut(2000);
		});

		$('#qrDownloadButton').on('click', function() {
			const downloadOption = $('#qrDownloadOption').val();
			const filename = $(this).data('branchname') + " QR Code";
			qrCode.download({name: filename.trim(), extension: downloadOption});
		});

		$('#getCodeForm').on('submit', function(e) {
			e.preventDefault();
			const formData = $(this).serialize();
			const url = $(this).attr('action');
			
			$.get(url, formData, function(response) {
				let branchText = 'No Branch';
				if (response.branchName != null) {
					branchText = response.branchName + ' (' + response.branchSystemName + ')';
				}
				bootstrap.Modal.getInstance($('#getModal')).hide();
				ResetSpinners();
				ShowViewModal(response.joinUrl, response.isQRCode, response.branchName, branchText);
				
			});
		});

		$('#deleteModal').on('show.bs.modal', function (event) {
			const button = $(event.relatedTarget);
			const id = button.data('id');
			const branchText = button.parent().siblings(".branchText").text();
			const typeText = button.parent().siblings(".typeText").text();
			const name = button.data('name');
			const modal = $(this);
			modal.find('#DeleteId').val(id);
			modal.find('#modal-text').html('Are you sure you wish to delete the <strong>' + typeText +  '</strong> join code for: <strong>' + branchText + '</strong>?');
		})

		function ShowViewModal(joinUrl, isQRCode, branchName, branchText) {
			const viewModal = new bootstrap.Modal($('#viewModal'));
			const qrContainer = $('#qrCodeContainer');
			const urlContainer = $('#urlLinkContainer');
			$('#viewModalLabel').text(branchText);
			if (isQRCode == true || isQRCode == "True") {
				urlContainer.hide();
				qrCode.update({data: joinUrl});
				qrCode.append($('#qrImage')[0]);
				let branchNameText = '';
				if (branchName != null) {
					branchNameText = branchName;
				}
				$('#qrDownloadButton').data('branchname', branchNameText);
				qrContainer.show();
			}
			else {
				qrContainer.hide();
				$('#urlInput').val(joinUrl);
				urlContainer.show();
			}
			viewModal.show();
		}
	</script>
}
